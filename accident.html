<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç—á–µ—Ç –æ –î–¢–ü | Wisconsin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f111a; --card: #161b22; --accent: #ef4444; --text: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .form-container { max-width: 500px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #2d334d; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #2d334d; background: #0d1117; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #94a3b8; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="form-container">
    <h2 style="text-align: center; color: var(--accent);">üö® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –î–¢–ü</h2>
    <p style="font-size: 13px; color: #94a3b8; text-align: center;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–∞ WPD</p>
    
    <input type="text" id="location" placeholder="–ú–µ—Å—Ç–æ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è (–†–∞–π–æ–Ω/–£–ª–∏—Ü–∞)">
    <input type="text" id="participants" placeholder="–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–ò–º–µ–Ω–∞/–ù–æ–º–µ—Ä–∞ –∞–≤—Ç–æ)">
    <textarea id="description" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤..."></textarea>
    
    <button id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
    <a href="dashboard.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</a>
</div>

<script>
    // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    const S_URL = 'https://exbhxsdwqznmroxrzxjp.supabase.co';
    const S_KEY = '–í–°–¢–ê–í–¨_–°–í–û–ô_–î–õ–ò–ù–ù–´–ô_–ö–õ–Æ–ß'; 
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    async function sendReport() {
        const btn = document.getElementById('submitBtn');
        const loc = document.getElementById('location').value;
        const part = document.getElementById('participants').value;
        const desc = document.getElementById('description').value;

        if (!loc  !part  !desc) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            return;
        }

        btn.disabled = true;
        btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

        try {
            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (!user) {
                alert("–û—à–∏–±–∫–∞: –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
                window.location.href = "index.html";
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞
            const reportContent = –ú–µ—Å—Ç–æ: ${loc} | –£—á–∞—Å—Ç–Ω–∏–∫–∏: ${part} | –û–ø–∏—Å–∞–Ω–∏–µ: ${desc};

            // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É
            const { error } = await supabaseClient
                .from('requests')
                .insert([{
                    user_id: user.id,
                    type: '–î–¢–ü',
                    content: reportContent,
                    status: 'pending'
                }]);

            if (error) throw error;

            alert("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
            window.location.href = "dashboard.html";

        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: " + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç";
        }
    }

    // 3. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫ –∫–Ω–æ–ø–∫–µ (—ç—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º onclick –≤ HTML)
    document.getElementById('submitBtn').addEventListener('click', sendReport);
</script>

</body>
</html>
