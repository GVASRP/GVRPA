<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisconsin Portal | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f111a; --card: #1a1d2e; --accent: #3b82f6; --police: #ef4444; --text: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* –°–µ—Ç–∫–∞ –º–µ–Ω—é */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #2d334d; cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card h3 { margin: 0 0 10px 0; }
        
        /* –°–∫—Ä—ã—Ç–∞—è –ø–ª–∏—Ç–∫–∞ –ø–æ–ª–∏—Ü–∏–∏ */
        .police-only { display: none; border-color: var(--police) !important; }
        .police-only:hover { box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

        /* –ß–∞—Ç */
        .chat-container { background: var(--card); border-radius: 15px; border: 1px solid #2d334d; overflow: hidden; display: flex; flex-direction: column; height: 400px; }
        .chat-header { background: #24293e; padding: 15px; font-weight: bold; border-bottom: 1px solid #2d334d; }
        #chatBox { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #2d334d; padding: 10px; border-radius: 8px; max-width: 80%; }
        .msg b { color: var(--accent); font-size: 12px; display: block; margin-bottom: 4px; }
        .chat-input { display: flex; padding: 15px; background: #24293e; gap: 10px; }
        input { flex: 1; background: #0d1117; border: 1px solid #2d334d; color: white; padding: 10px; border-radius: 6px; outline: none; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn { background: #334155; padding: 8px 15px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Wisconsin Portal</h1>
        <button class="btn logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>

    <div class="grid">
        <div class="card" onclick="location.href='passport.html'">
            <h3>ü™™ –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–π —Å—Ç–æ–ª</h3>
            <p>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ID-–∫–∞—Ä—Ç—ã</p>
        </div>
        <div class="card" onclick="location.href='vehicle.html'">
            <h3>üöó –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ</h3>
            <p>–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¢–° –Ω–∞ —É—á–µ—Ç</p>
        </div>
        <div class="card" onclick="location.href='licensing.html'">
            <h3>üìÑ –õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <p>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π</p>
        </div>

        <div class="card police-only" id="policeCard" onclick="location.href='police_base.html'">
            <h3 style="color: #ef4444;">üöî –ë–∞–∑–∞ –ú–í–î</h3>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∏ —Ä–æ–∑—ã—Å–∫</p>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">üí¨ –û–±—â–∏–π —á–∞—Ç —à—Ç–∞—Ç–∞</div>
        <div id="chatBox"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
            <button class="btn" onclick="sendMsg()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    const S_URL = 'https://exbhxsdwqznmroxrzxjp.supabase.co';
    const S_KEY = '–¢–í–û–ô_–ö–õ–Æ–ß_–°–Æ–î–ê'; 
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    // 1. –ü–†–û–í–ï–†–ö–ê –†–û–õ–ò –ò –î–û–°–¢–£–ü–ê
    async function initDashboard() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = 'index.html';
            return;
        }

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –≤ —Ç–∞–±–ª–∏—Ü–µ profiles
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', user.id)
            .single();

        if (profile && (profile.role === 'police' || profile.role === 'admin')) {
            document.getElementById('policeCard').style.display = 'block';
        }

        loadMessages();
        subscribeToChat();
    }

    // 2. –õ–û–ì–ò–ö–ê –ß–ê–¢–ê
    async function loadMessages() {
        const { data: messages } = await supabaseClient
            .from('messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(50);
        
        if (messages) {
            messages.forEach(renderMessage);
        }
    }

    function renderMessage(msg) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = <b>${msg.user_name}</b> ${msg.text};
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMsg() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        const { data: { user } } = await supabaseClient.auth.getUser();
        const userName = user.email.split('@')[0];

        await supabaseClient.from('messages').insert([{ 
            text: text, 
            user_id: user.id, 
            user_name: userName 
        }]);

        input.value = '';
    }

    function subscribeToChat() {
        supabaseClient
            .channel('chat-room')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                renderMessage(payload.new);
            })
            .subscribe();
    }

    // 3. –í–´–•–û–î
    async function logout() {
        await supabaseClient.auth.signOut();
        window.location.href = 'index.html';
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å Enter –¥–ª—è —á–∞—Ç–∞
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMsg();
    });

    initDashboard();
</script>
</body>
</html>
